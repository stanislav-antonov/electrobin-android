<!doctype html>
<html>
    <head>
        <title>Route</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
        <script src="http://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
        <meta name="viewport" content="width=device-width,height=device-height, user-scalable=no" />
        <script type="text/javascript">
            var myMap;
            var placemark;
            var locationArrow;

            ymaps.ready(function () {
                var initCoords = [55.53638053374438,37.529385721565184];
                myMap = new ymaps.Map('map', {
                    center: initCoords,
                    zoom: 16,
                    geoObjectOverlayFactory: 'default#interactiveGraphics'
                });

                Android.onMapReady();
            });

            function updatePosition(lat, long, bearing) {
                var coords = [lat, long];
                myMap.panTo([coords]).then(
                    function () {
                        if (!locationArrow) {
                            locationArrow = new ymaps.Placemark(
                                coords, {}, {
                                    iconLayout: 'default#image',
                                    iconShadow: false,
                                    iconImageHref: 'http://185.118.64.121:8081/static/img/location_arrow.png',
                                    iconImageSize: [32, 32],
                                    iconImageOffset: [0, 0],
                                    iconOffset: [0, 0],
                                }
                            );

                            myMap.geoObjects.add(locationArrow);
                        }
                        else {
                            locationArrow.geometry.setCoordinates(coords);
                        }

                        locationArrow.getOverlay().then(function (value) {
                            var $ico = $(value.getIconElement());
                            $ico.css('transform', 'rotate(' + bearing + 'deg)');
                        }, function (err) {
                            console.log('Ошибка: ' + err);
                        });
                    },
                    function (err) {},
                    this
                );
            }

            function displayRoute(route) {
                // var route = '{"start_point":{"longitude":44.5837853,"latitude":48.7869476},"way_points":[{"unique_id":1,"longitude":44.57456924862674,"latitude":48.785346371124746},{"unique_id":2,"longitude":44.58332181428101,"latitude":48.78560940518449}]}';
                route = $.parseJSON(route);

                var points = [];
                var hasStartPoint = false;

                if (route.hasOwnProperty("start_point")) {
                    var startPoint = route.start_point;
                    points.push({ type: "wayPoint", point: [ startPoint.latitude, startPoint.longitude ] });
                    hasStartPoint = true;
                }

                var wayPoints = route.way_points;
                for (i = 0; i < wayPoints.length; i++) {
                    var wayPoint = wayPoints[i];
                    points.push({ type: "wayPoint", point: [ wayPoint.latitude, wayPoint.longitude ] });
                }

                Android.onRouteBuildingStart();

                ymaps.route(points, {avoidTrafficJams: true, mapStateAutoApply: true}).then(
                    function (route) {
                        // var points = route.getViaPoints();
                        var points = route.getWayPoints();

                        var startPoint = null;
                        if (hasStartPoint) {
                            startPoint = points.get(0);
                            points.remove(startPoint);
                        }

                        points.each(function (point, i) {
                            var uniqueId = wayPoints[i].unique_id;
                            point.properties.set("unique_id", uniqueId);
                            point.properties.set("iconContent", uniqueId);

                            // https://tech.yandex.ru/maps/doc/jsapi/2.0/ref/reference/GeoObject-docpage/
                            point.options.set({
                                hasBalloon: false
                            });

                            point.events.add("click", function () {
                                Android.onRoutePointClick(point.properties.get("unique_id"));
                            });
                        });

                        if (hasStartPoint && startPoint != null) {
                            var startPointPlacemark = new ymaps.Placemark(startPoint.geometry.getCoordinates(), {}, {
                                hasBalloon: false,
                                iconColor: "0066ff99"
                            });

                            points.add(startPointPlacemark, 0);
                        }

                        myMap.geoObjects.add(route);

                        Android.onRouteBuildingReady();
                    },
                    function (error) {
                        alert(error.message);
                    }
                );
            }
        </script>
        <style>
            html, body, #map {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #map {
                background-color: black;
            }

            #button {
                position: absolute;
                height: 20px;
                top: 10px; left: 10px;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
    </body>
</html>